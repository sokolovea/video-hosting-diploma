<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Страница управления плейлистами">
  <meta th:name="_csrf" th:content="${_csrf.token}"/>
  <meta th:name="_csrf_header" th:content="${_csrf.headerName}"/>
  <title>Мои плейлисты</title>
  <link rel="stylesheet" href="/css/styles.css">
  <style>
    body {
      font-family: Arial, sans-serif;
    }

    .container {
      max-width: 800px;
      margin: 20px auto;
    }

    h2 {
      text-align: center;
      margin-bottom: 20px;
    }

    .form-inline {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-bottom: 20px;
    }

    .playlist-card {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      background-color: #f9f9f9;
    }

    .playlist-buttons {
      display: flex;
      gap: 10px;
    }

    .playlist-buttons button {
      padding: 5px 10px;
      cursor: pointer;
      border-radius: 5px;
      border: none;
    }

    .view-button {
      background-color: #28a745;
      color: white;
    }

    .delete-button {
      background-color: #ff6666;
      color: white;
    }

    .rename-button {
      background-color: #ffc107;
      color: white;
    }

    .playlist-videos-table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
    }

    .playlist-videos-table th, .playlist-videos-table td {
      padding: 10px;
      border: 1px solid #ddd;
    }

    .playlist-videos-table th {
      background-color: #f2f2f2;
    }

  </style>
</head>
<body>
<div th:replace="fragments/header.html"></div>

<div class="container">
  <section>
    <h2>Управление плейлистами</h2>

    <!-- Форма создания плейлиста -->
    <div class="form-inline" style="display: flex; align-items: center;">
      <label for="newPlaylistName">Введите название плейлиста</label><input type="text" id="newPlaylistName" placeholder="Название плейлиста" required>
      <button class="view-button" onclick="createPlaylist()">Создать</button>
    </div>

    <!-- Список плейлистов -->
    <div id="playlistContainer"></div>
  </section>

  <!-- Список видео в плейлисте -->
  <section id="playlistVideosSection" style="display: none;">
    <h2 id="playlistTitle">Видео в плейлисте</h2>

    <!-- Таблица видео -->
    <table class="playlist-videos-table">
      <thead>
      <tr>
        <th>Миниатюра</th>
        <th>Название видео</th>
        <th>Действие</th>
      </tr>
      </thead>
      <tbody id="videoList"></tbody>
    </table>
  </section>
</div>

<script>
  const apiUrl = '/api/playlists';

  async function fetchPlaylists() {
    const response = await fetch(apiUrl);
    const playlists = await response.json();

    const container = document.getElementById('playlistContainer');
    container.innerHTML = '';

    playlists.forEach(playlist => {
      const card = document.createElement('div');
      card.classList.add('playlist-card');
      card.innerHTML = `
        <span>${playlist.name}</span>
        <div class="playlist-buttons">
          <button class="view-button" onclick="viewPlaylist(${playlist.id})">Просмотреть</button>
          <button class="rename-button" onclick="renamePlaylist(${playlist.id})">Переименовать</button>
          <button class="delete-button" onclick="deletePlaylist(${playlist.id})">Удалить</button>
        </div>
      `;
      container.appendChild(card);
    });
  }

  async function createPlaylist() {
    const name = document.getElementById('newPlaylistName').value;

    if (name.trim() === '') {
      alert('Введите название плейлиста');
      return;
    }

    const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');

    const answer = await fetch(apiUrl + '/create', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-CSRF-TOKEN': csrfToken},
      body: JSON.stringify({ title: name })
    });

    if (answer.status === 409) {
      alert('Плейлист с заданным именем уже существует!')
    }

    document.getElementById('newPlaylistName').value = '';

    await fetchPlaylists();
  }

  async function renamePlaylist(id) {
    const newName = prompt('Введите новое название плейлиста');
    if (!newName) return;

    const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');

    const answer = await fetch(apiUrl + '/rename', {
      method: 'PUT',
      headers: {'Content-Type': 'application/json', 'X-CSRF-TOKEN': csrfToken},
      body: JSON.stringify({playlistId: id, newPlaylistName: newName})
    });

    if (answer.status === 409) {
      alert('Плейлист с заданным именем уже существует!')
    }

    await fetchPlaylists();
  }

  async function deletePlaylist(id) {
    const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
    await fetch(apiUrl + '/delete', {
      method: 'DELETE',
      headers: { 'Content-Type': 'application/json', 'X-CSRF-TOKEN': csrfToken},
      body: JSON.stringify({ playlistId: id })
    });

    await fetchPlaylists();
  }

  async function viewPlaylist(id) {
    const response = await fetch(apiUrl + `/${id}/videos`);
    const playlist = await response.json();

    document.getElementById('playlistTitle').textContent = `Видео в плейлисте: ${playlist.name}`;
    const videoList = document.getElementById('videoList');
    videoList.innerHTML = '';

    playlist.videos.forEach(video => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td><img src="${video.imagePath}" class="thumbnail"></td>
        <td><a href="/video/${video.id}">${video.title}</a></td>
        <td>
          <button class="delete-button" onclick="removeVideoFromPlaylist(${id}, ${video.id})">Удалить</button>
        </td>
      `;
      videoList.appendChild(row);
    });

    document.getElementById('playlistVideosSection').style.display = 'block';
  }

  async function addVideoToPlaylist() {
    const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
    const playlistId = document.getElementById('playlistTitle').dataset.id;
    const videoId = document.getElementById('videoIdInput').value;

    if (!videoId.trim()) {
      alert('Введите ID видео');
      return;
    }

    await fetch(apiUrl + '/add-video', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-CSRF-TOKEN': csrfToken },
      body: JSON.stringify({ playlistId: playlistId, videoId: videoId })
    });

    document.getElementById('videoIdInput').value = '';
    viewPlaylist(playlistId);
  }

  async function removeVideoFromPlaylist(playlistId, videoId) {
    const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
    await fetch(apiUrl + '/remove-video', {
      method: 'DELETE',
      headers: { 'Content-Type': 'application/json', 'X-CSRF-TOKEN': csrfToken },
      body: JSON.stringify({ playlistId: playlistId, videoId: videoId  })
    });

    viewPlaylist(playlistId);
  }

  // Инициализация
  fetchPlaylists();
</script>

</body>
</html>
